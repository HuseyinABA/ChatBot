# -*- coding: utf-8 -*-
"""Untitled

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Svj-4Y00kA8R62f9orAp7eukAHwvS_kE
"""

import pandas as pd
import numpy as np
from sklearn.preprocessing import LabelEncoder, MinMaxScaler, StandardScaler
from google.colab import drive
import os
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.cluster import KMeans
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression
from sklearn.metrics import mean_absolute_error, mean_squared_error
import tensorflow as tf
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Dense, Dropout, BatchNormalization
from tensorflow.keras.callbacks import EarlyStopping
from tensorflow.keras.utils import to_categorical

if not os.path.exists('/content/drive'):
    drive.mount('/content/drive')

# --- 2. VERÄ° YÃœKLEME
file_path = '/content/drive/MyDrive/customer_shopping_data.csv'

# Dosya yolu kontrolÃ¼
if not os.path.exists(file_path):
    # EÄŸer Drive'da bulamazsa local'e bakar
    file_path = 'customer_shopping_data.csv'
    if not os.path.exists(file_path):
         raise FileNotFoundError(f"âŒ Dosya bulunamadÄ±! LÃ¼tfen dosyanÄ±n '/content/drive/MyDrive/' altÄ±nda olduÄŸundan emin ol.")

print(f"ğŸ“‚ Dosya okunuyor: {file_path}")


try:
    df = pd.read_csv(file_path, on_bad_lines='skip')
    print(f"âœ… Veri baÅŸarÄ±yla yÃ¼klendi! Toplam satÄ±r: {len(df)}")
except Exception as e:
    print(f"âŒ Veri okunurken kritik hata: {e}")
    # Hata durumunda iÅŸlemi durdur
    raise

# --- 3. VERÄ° Ã–N Ä°ÅLEME ---

# A) Tarih DÃ¼zenleme
df['invoice_date'] = pd.to_datetime(df['invoice_date'], dayfirst=True, errors='coerce')
df.dropna(subset=['invoice_date'], inplace=True)

# Hafta sonu Ã¶zelliÄŸi
df['is_weekend'] = df['invoice_date'].dt.weekday.apply(lambda x: 1 if x >= 5 else 0)
print("âœ… 'is_weekend' Ã¶zelliÄŸi eklendi.")

# B) Kategorik DeÄŸiÅŸkenleri SayÄ±sallaÅŸtÄ±rma (Encoding)
categorical_cols = ['gender', 'category', 'payment_method', 'shopping_mall']
encoders = {}

print("\n--- Encoding Ä°ÅŸlemi ---")
for col in categorical_cols:
    le = LabelEncoder()
    df[col] = le.fit_transform(df[col].astype(str))
    encoders[col] = le

    # Kontrol Ã§Ä±ktÄ±sÄ±
    mapping = dict(zip(le.classes_, le.transform(le.classes_)))
    first_3 = list(mapping.items())[:3]
    print(f"   -> {col} kodlandÄ±. Ã–rn: {first_3}...")

# C) Normalizasyon
# UyarÄ±larÄ± (SettingWithCopy) engellemek iÃ§in direkt atama yapÄ±yoruz
scaler_age = MinMaxScaler()
df['age'] = scaler_age.fit_transform(df[['age']])

scaler_price = StandardScaler()
df['price'] = scaler_price.fit_transform(df[['price']])
print("âœ… Veriler normalize edildi (YaÅŸ: 0-1, Fiyat: Z-Score).")

print("\n--- AÅAMA 1 TAMAMLANDI ---")
print(df[['age', 'price', 'is_weekend', 'category', 'shopping_mall']].head())

# Grafik ayarlarÄ±
plt.rcParams['figure.figsize'] = (14, 10)
sns.set_style("whitegrid")

# 1. KATEGORÄ° DAÄILIMI
plt.subplot(2, 2, 1)
# SayÄ±sal veriyi Ã§izdiriyoruz
ax1 = sns.countplot(x='category', data=df, order=df['category'].value_counts().index, palette='viridis')
# Eksenleri okunabilir metne Ã§eviriyoruz
ax1.set_xticklabels(encoders['category'].inverse_transform(ax1.get_xticks()), rotation=45)
plt.title("En Ã‡ok SatÄ±lan ÃœrÃ¼n Kategorileri")

# 2. AVM DAÄILIMI
plt.subplot(2, 2, 2)
ax2 = sns.countplot(y='shopping_mall', data=df, order=df['shopping_mall'].value_counts().index, palette='rocket')
ax2.set_yticklabels(encoders['shopping_mall'].inverse_transform(ax2.get_yticks()))
plt.title("AVM MÃ¼ÅŸteri YoÄŸunluÄŸu")

# 3. HAFTANIN GÃœNLERÄ° ANALÄ°ZÄ°
# GÃ¼n isimleri (0: Pazartesi - 6: Pazar)
df['day_name'] = df['invoice_date'].dt.day_name()
days_order = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']

plt.subplot(2, 2, 3)
sns.countplot(x='day_name', data=df, order=days_order, palette='coolwarm')
plt.xticks(rotation=45)
plt.title("GÃ¼nlere GÃ¶re AlÄ±ÅŸveriÅŸ SÄ±klÄ±ÄŸÄ±")

# 4. NORMALÄ°ZE EDÄ°LMÄ°Å HARCAMA DAÄILIMI (Price)
plt.subplot(2, 2, 4)
sns.histplot(df['price'], bins=30, kde=True, color='purple')
plt.title("Harcama DaÄŸÄ±lÄ±mÄ± (Normalize EdilmiÅŸ)")
plt.xlabel("Z-Skoru (0 = Ortalama Fiyat)")

plt.tight_layout()
plt.show()

# Ä°statistiksel Ã–zet
print(f"Toplam Ä°ÅŸlem SayÄ±sÄ±: {len(df)}")
print("\nKategori BazlÄ± Ä°ÅŸlem SayÄ±larÄ± (Ä°lk 5):")
print(df['category'].value_counts().rename(index=dict(zip(range(len(encoders['category'].classes_)), encoders['category'].classes_))).head())

# 1. KÃœMELEME (CLUSTERING)
# Model iÃ§in gerekli Ã¶zellikleri seÃ§elim (zaten normalize etmiÅŸtik)
X_cluster = df[['age', 'price', 'is_weekend']]

# KMeans Modelini Kuruyoruz (K=4 KÃ¼me ideal bir baÅŸlangÄ±Ã§tÄ±r)
kmeans = KMeans(n_clusters=4, random_state=42, n_init=10)
df['cluster_label'] = kmeans.fit_predict(X_cluster)

# 2. SONUÃ‡LARI YORUMLAMA (INTERPRETATION)
# KÃ¼melerin merkez noktalarÄ±nÄ± (ortalama deÄŸerlerini) alalÄ±m
cluster_summary = df.groupby('cluster_label')[['age', 'price', 'is_weekend']].mean()

# Normalize edilmiÅŸ deÄŸerleri gerÃ§ek deÄŸerlere (TL ve YaÅŸ) Ã§evirelim ki anlayabilelim
# Inverse Transform iÅŸlemleri:
cluster_summary['GerÃ§ek_YaÅŸ'] = scaler_age.inverse_transform(cluster_summary[['age']])
cluster_summary['GerÃ§ek_Fiyat'] = scaler_price.inverse_transform(cluster_summary[['price']])

# Tabloyu dÃ¼zenleyip yazdÄ±ralÄ±m
print("\n--- MÃ¼ÅŸteri Segmentleri (K-Means SonuÃ§larÄ±) ---")
print(cluster_summary[['GerÃ§ek_YaÅŸ', 'GerÃ§ek_Fiyat', 'is_weekend']].round(1))

# 3. KÃœME DAÄILIMI
print("\nHer kÃ¼mede kaÃ§ kiÅŸi var?")
print(df['cluster_label'].value_counts())

# 1. Ã–ZELLÄ°K VE HEDEF BELÄ°RLEME
# Modeli besleyeceÄŸimiz bilgiler (Features)
X = df[['age', 'gender', 'category', 'shopping_mall', 'is_weekend']]

# Tahmin etmeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±z deÄŸer (Target) - Normalize edilmiÅŸ fiyatÄ± kullanÄ±yoruz
y = df['price']

# 2. VERÄ° SETÄ°NÄ° BÃ–LME (Train %80 - Test %20)
# random_state=42 sayesinde her Ã§alÄ±ÅŸtÄ±rmada aynÄ± ayrÄ±mÄ± yapar (tekrarlanabilirlik)
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

print(f"EÄŸitim Seti: {X_train.shape}, Test Seti: {X_test.shape}")

# 3. BASELINE MODEL KURULUMU (Lineer Regresyon)
model_lr = LinearRegression()
model_lr.fit(X_train, y_train)

# 4. TAHMÄ°N VE DEÄERLENDÄ°RME
y_pred = model_lr.predict(X_test)

# Metrikleri Hesapla (Scaled Data Ã¼zerinden)
mae = mean_absolute_error(y_test, y_pred)
rmse = np.sqrt(mean_squared_error(y_test, y_pred))

print(f"\n--- Baseline Model PerformansÄ± (Scaled) ---")
print(f"MAE (Ortalama Mutlak Hata): {mae:.4f}")
print(f"RMSE (KÃ¶k Ortalama Kare Hata): {rmse:.4f}")

# 5. GERÃ‡EK TL KARÅILIÄINI GÃ–RMEK Ä°Ã‡Ä°N
# Normalize edilmiÅŸ hatayÄ± (Ã¶rn: 0.74) gerÃ§ek TL'ye Ã§evirelim ki iÅŸ birimi anlasÄ±n.
# scaler_price nesnesini AÅAMA 1'de oluÅŸturmuÅŸtuk.
# Inverse transform 2D array bekler, reshape yapÄ±yoruz.
sample_error_scaled = np.array([[mae]])
real_error_try = scaler_price.inverse_transform(sample_error_scaled)[0][0]

# Not: Inverse transform iÅŸlemi verinin ortalamasÄ±nÄ± (mean) geri ekler,
# sadece Ã¶lÃ§ek katsayÄ±sÄ±nÄ± (std) almak iÃ§in standart sapma ile Ã§arpmak daha doÄŸrudur.
# DoÄŸru yÃ¶ntem: Hata * Standart Sapma
real_mae_try = mae * scaler_price.scale_[0]

print(f"\n--- GerÃ§ek DÃ¼nya HatasÄ± ---")
print(f"Model ortalama +/- {real_mae_try:.2f} TL yanÄ±lÄ±yor.")

# --- 1. MODEL MÄ°MARÄ°SÄ° (MLP Regressor) ---
# Sequential: KatmanlarÄ± arka arkaya dizmek demektir.
model_price = Sequential([
    # Girdi KatmanÄ± + 1. Gizli Katman
    # input_shape: Modele kaÃ§ tane Ã¶zellik verdiÄŸimiz (X_train.shape[1])
    Dense(128, activation='relu', input_shape=(X_train.shape[1],)),
    BatchNormalization(), # Veriyi dengeler, eÄŸitimi hÄ±zlandÄ±rÄ±r
    Dropout(0.3),         # Rastgele %30 nÃ¶ronu kapat (Overfitting Ã¶nleyici)

    # 2. Gizli Katman
    Dense(64, activation='relu'),
    BatchNormalization(),
    Dropout(0.2),

    # 3. Gizli Katman
    Dense(32, activation='relu'),

    # Ã‡Ä±ktÄ± KatmanÄ±
    # Tek bir sayÄ± (Fiyat) tahmin ettiÄŸimiz iÃ§in 1 nÃ¶ron.
    # Aktivasyon 'linear' (veya boÅŸ) Ã§Ã¼nkÃ¼ eksi veya artÄ± herhangi bir sayÄ± Ã§Ä±kabilir.
    Dense(1, activation='linear')
])

# --- 2. MODELÄ° DERLEME (COMPILE) ---
# Optimizer: Adam (En yaygÄ±n ve baÅŸarÄ±lÄ± algoritma)
# Loss: MSE (HatanÄ±n karesine odaklanÄ±r, bÃ¼yÃ¼k hatalarÄ± daha Ã§ok cezalandÄ±rÄ±r)
# Metrics: MAE (Bizim anlayacaÄŸÄ±mÄ±z dildeki ortalama hata)
model_price.compile(optimizer='adam', loss='mse', metrics=['mae'])

# --- 3. EÄÄ°TÄ°M (TRAINING) ---
print("ğŸš€ Model EÄŸitimi BaÅŸlÄ±yor...")

# EarlyStopping: EÄŸer model 10 tur boyunca geliÅŸmezse eÄŸitimi erken bitir.
early_stop = EarlyStopping(monitor='val_loss', patience=10, restore_best_weights=True)

history_price = model_price.fit(
    X_train, y_train,
    validation_data=(X_test, y_test),
    epochs=50,          # Maksimum 50 tur dÃ¶nsÃ¼n
    batch_size=32,      # Her seferinde 32 mÃ¼ÅŸteriye bakÄ±p Ã¶ÄŸrensin
    callbacks=[early_stop],
    verbose=1           # EÄŸitim detaylarÄ±nÄ± gÃ¶ster
)

# --- 4. SONUÃ‡ VE KAYIT ---
# Test seti Ã¼zerinde son durumu gÃ¶relim
loss, mae_dl = model_price.evaluate(X_test, y_test, verbose=0)
print(f"\nâœ… Derin Ã–ÄŸrenme Modeli TamamlandÄ±!")
print(f"ğŸ“‰ Test Seti Hata PayÄ± (Scaled MAE): {mae_dl:.4f}")

# GerÃ§ek TL hatasÄ±nÄ± hesaplayalÄ±m (YaklaÅŸÄ±k)
real_mae_dl = mae_dl * scaler_price.scale_[0]
print(f"ğŸ’° GerÃ§ek Tahmin HatasÄ±: +/- {real_mae_dl:.2f} TL")

# Modeli Kaydet
model_price.save('retail_price_model.h5')
print("ğŸ’¾ Model 'retail_price_model.h5' olarak kaydedildi.")

# --- 1. VERÄ° HAZIRLIÄI (Classification Ä°Ã§in) ---
# Girdiler: YaÅŸ, Cinsiyet, AVM, Hafta Sonu
# NOT: FiyatÄ± (Price) girdilere koymuyoruz, Ã§Ã¼nkÃ¼ mÃ¼ÅŸteri daha Ã¶deme yapmadÄ±, ne alacaÄŸÄ±nÄ± tahmin etmeye Ã§alÄ±ÅŸÄ±yoruz.
X_cat = df[['age', 'gender', 'shopping_mall', 'is_weekend']]

# Hedef: Kategori (0: Clothing, 1: Cosmetics vb.)
y_cat_raw = df['category']

# Hedefi One-Hot Encoding'e Ã§evirmeliyiz (Derin Ã–ÄŸrenme sÄ±nÄ±flandÄ±rma formatÄ±)
# Ã–rn: Kategori 2 -> [0, 0, 1, 0, 0...]
num_classes = len(encoders['category'].classes_)
y_cat = to_categorical(y_cat_raw, num_classes=num_classes)

# EÄŸitim ve Test Setine BÃ¶lme
X_train_cat, X_test_cat, y_train_cat, y_test_cat = train_test_split(X_cat, y_cat, test_size=0.2, random_state=42)

print(f"SÄ±nÄ±flandÄ±rma Verisi HazÄ±r. SÄ±nÄ±f SayÄ±sÄ±: {num_classes}")

# --- 2. MODEL MÄ°MARÄ°SÄ° (Classification MLP) ---
model_class = Sequential([
    # 1. Katman
    Dense(128, activation='relu', input_shape=(X_train_cat.shape[1],)),
    BatchNormalization(),
    Dropout(0.3),

    # 2. Katman
    Dense(64, activation='relu'),
    BatchNormalization(),
    Dropout(0.2),

    # 3. Katman
    Dense(32, activation='relu'),

    # Ã‡IKTI KATMANI
    # NÃ¶ron sayÄ±sÄ± = Kategori sayÄ±sÄ± kadar (num_classes)
    # Aktivasyon = 'softmax' (OlasÄ±lÄ±k daÄŸÄ±lÄ±mÄ± verir)
    Dense(num_classes, activation='softmax')
])

# --- 3. DERLEME (Accuracy Burada!) ---
model_class.compile(
    optimizer='adam',
    loss='categorical_crossentropy',  # Ã‡oklu sÄ±nÄ±flandÄ±rma iÃ§in standart kayÄ±p fonksiyonu
    metrics=['accuracy']              # Ä°ÅTE Ä°STEDÄ°ÄÄ°N METRÄ°K
)

# --- 4. EÄÄ°TÄ°M ---
print("ğŸš€ Kategori Tahmin Modeli EÄŸitiliyor...")
history_class = model_class.fit(
    X_train_cat, y_train_cat,
    validation_data=(X_test_cat, y_test_cat),
    epochs=50,
    batch_size=16,
    callbacks=[EarlyStopping(monitor='val_loss', patience=5, restore_best_weights=True)],
    verbose=1
)

# --- 5. SONUÃ‡ ---
loss, acc = model_class.evaluate(X_test_cat, y_test_cat, verbose=0)
print(f"\nâœ… Model TamamlandÄ±!")
print(f"ğŸ¯ Test Seti DoÄŸruluk OranÄ± (Accuracy): %{acc * 100:.2f}")

# Modeli Kaydet
model_class.save('retail_category_model.h5')
print("ğŸ’¾ Model 'retail_category_model.h5' olarak kaydedildi.")

# --- 1. KÃœTÃœPHANE KURULUMU ---
# Bu satÄ±r Google'Ä±n yapay zeka kÃ¼tÃ¼phanesini Colab ortamÄ±na kurar.
!pip install -q -U google-generativeai

import google.generativeai as genai
import json

# --- 2. API AYARLARI ---
# Senin verdiÄŸin anahtarÄ± buraya ekledim.
API_KEY = ".env"

genai.configure(api_key=API_KEY)

# --- 3. SYSTEM PROMPT (Zeka KatmanÄ±) ---
# Gemini'ye bir "Veri MÃ¼hendisi" gibi davranmasÄ±nÄ± emrediyoruz.
system_instruction = """
Sen bir "Veri Ã‡Ä±karÄ±m UzmanÄ±sÄ±n". GÃ¶revin, kullanÄ±cÄ±dan gelen doÄŸal dil metnini analiz edip,
aÅŸaÄŸÄ±daki JSON formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rmektir.

Ã‡IKTI FORMATI (Sadece bu JSON'u dÃ¶ndÃ¼r, baÅŸka aÃ§Ä±klama yapma):
{
  "age": (integer veya null - Ã¶rn: 25),
  "gender": ("Male", "Female" veya null - baÄŸlamdan Ã§Ä±kar, "kÄ±z arkadaÅŸÄ±m" denirse null al),
  "mall": (AlÄ±ÅŸveriÅŸ merkezi ismi veya null - Ã¶rn: "Kanyon", "Zorlu"),
  "day_type": ("Weekend" veya "Weekday" - Ã¶rn: "Cumartesi" ise Weekend, "BugÃ¼n SalÄ±" ise Weekday),
  "payment_method": ("Credit Card", "Cash", "Debit Card" veya null),
  "intent": ("prediction" veya "chat")
}

KURALLAR:
1. EÄŸer bilgi yoksa "null" deÄŸerini kullan.
2. AVM isimlerini en yakÄ±n bilinen isme eÅŸle (Ã¶rn: "Kanyon AVM" -> "Kanyon").
3. Sadece JSON dÃ¶ndÃ¼r. Markdown (```json) kullanma.
"""

# Modeli HazÄ±rla (HÄ±zlÄ± ve hafif model: Flash)
model_gemini = genai.GenerativeModel(
    model_name="gemini-1.5-flash",
    system_instruction=system_instruction
)

# --- 4. TEST FONKSÄ°YONU ---
def extract_entities(user_text):
    """
    KullanÄ±cÄ± metnini alÄ±r, Gemini'ye gÃ¶nderir ve JSON olarak geri dÃ¶ndÃ¼rÃ¼r.
    """
    try:
        response = model_gemini.generate_content(user_text)
        # Bazen Gemini ```json etiketi ekler, onlarÄ± temizleyelim
        cleaned_text = response.text.replace("```json", "").replace("```", "").strip()
        return json.loads(cleaned_text)
    except Exception as e:
        print(f"Hata oluÅŸtu: {e}")
        return None

# --- 5. CANLI TEST ---
print("Gemini Test Ediliyor...")
ornek_cumle = "30 yaÅŸÄ±ndayÄ±m, bugÃ¼n Pazar ve Zorlu Center'da kendime bir ÅŸeyler bakÄ±yorum."
sonuc = extract_entities(ornek_cumle)

print(f"\nğŸ—£ï¸ KullanÄ±cÄ±: {ornek_cumle}")
print(f"ğŸ¤– Gemini Ã‡Ä±ktÄ±sÄ± (JSON): {sonuc}")

import numpy as np

# --- MAPPING FONKSÄ°YONU ---
def prepare_input_for_category_model(json_data):
    """
    Gemini'den gelen JSON'u, Kategori Tahmin Modeli iÃ§in sayÄ±sal vektÃ¶re Ã§evirir.
    Girdi SÄ±rasÄ±: [age, gender, shopping_mall, is_weekend]
    """

    # 1. VARSAYILAN DEÄERLER (EÄŸer kullanÄ±cÄ± sÃ¶ylemediyse)
    # Veri setindeki en yaygÄ±n deÄŸerleri (Mode) varsayÄ±lan olarak seÃ§iyoruz.
    defaults = {
        "age": 30,              # Ortalama yaÅŸ
        "gender": "Female",     # En Ã§ok bulunan cinsiyet
        "mall": "Kanyon",       # PopÃ¼ler AVM
        "day_type": "Weekend"   # Haftasonu varsayÄ±mÄ±
    }

    # JSON'dan veriyi al, yoksa varsayÄ±lanÄ± kullan
    age_val = json_data.get("age") if json_data.get("age") is not None else defaults["age"]
    gender_val = json_data.get("gender") if json_data.get("gender") is not None else defaults["gender"]
    mall_val = json_data.get("mall") if json_data.get("mall") is not None else defaults["mall"]
    day_val = json_data.get("day_type") if json_data.get("day_type") is not None else defaults["day_type"]

    # --- 2. DÃ–NÃœÅÃœMLER (ENCODING & SCALING) ---
    input_vector = []

    # A) YAÅ (Normalize Etmeliyiz: 0-1 arasÄ±)
    # scaler_age nesnesini AÅŸama 1'de eÄŸitmiÅŸtik.
    # Scaler 2D array bekler, o yÃ¼zden [[age_val]] yapÄ±yoruz.
    age_scaled = scaler_age.transform([[age_val]])[0][0]
    input_vector.append(age_scaled)

    # B) CÄ°NSÄ°YET (Label Encoding)
    try:
        # 'Female' -> 0, 'Male' -> 1 (SÃ¶zlÃ¼kten bakÄ±yoruz)
        gender_encoded = encoders['gender'].transform([gender_val])[0]
    except:
        # EÄŸer "Robot" gibi bilinmeyen bir ÅŸey gelirse varsayÄ±lanÄ± kullan
        gender_encoded = encoders['gender'].transform([defaults["gender"]])[0]
    input_vector.append(gender_encoded)

    # C) AVM (Label Encoding)
    try:
        # Veri setinde olmayan bir AVM gelirse (Ã¶rn: "Akasya"), varsayÄ±lan (Kanyon) olsun.
        mall_encoded = encoders['shopping_mall'].transform([mall_val])[0]
    except:
        print(f"UyarÄ±: '{mall_val}' veri setinde yok, varsayÄ±lan AVM kullanÄ±lÄ±yor.")
        mall_encoded = encoders['shopping_mall'].transform([defaults["mall"]])[0]
    input_vector.append(mall_encoded)

    # D) HAFTA SONU (Binary)
    is_weekend = 1 if day_val == "Weekend" else 0
    input_vector.append(is_weekend)

    # --- 3. SONUÃ‡ ---
    # Model (1, 4) boyutunda matris bekler (1 satÄ±r, 4 Ã¶zellik)
    return np.array([input_vector])

# --- TEST ---
print("--- Mapping Testi ---")

# Ã–rnek 1: Gemini'den gelmiÅŸ gibi bir JSON
test_json = {'age': 25, 'gender': 'Female', 'mall': 'Mall of Istanbul', 'day_type': 'Weekday'}
vector = prepare_input_for_category_model(test_json)

print(f"Gelen JSON: {test_json}")
print(f"Modele Girecek VektÃ¶r: {vector}")
print(f"VektÃ¶r Boyutu: {vector.shape}") # (1, 4) olmalÄ±

# --- 1. KURULUM ---
# HÄ±zlÄ± web Ã§atÄ±sÄ± ve gerekli araÃ§larÄ± kuruyoruz
!pip install -q fastapi uvicorn pyngrok nest_asyncio

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import nest_asyncio
import uvicorn

# --- 2. AYARLAR ---
# Colab'in kendi dÃ¶ngÃ¼sÃ¼ (loop) olduÄŸu iÃ§in Ã§akÄ±ÅŸmayÄ± Ã¶nleyen yama
nest_asyncio.apply()

# UygulamayÄ± Yarat
app = FastAPI()

# CORS AyarlarÄ± (TarayÄ±cÄ±dan eriÅŸim izni iÃ§in kritik)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"], # Her yerden gelen isteÄŸi kabul et
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- 3. VERÄ° MODELÄ° ---
# Frontend'den bize ne gelecek? Sadece bir mesaj.
class UserInput(BaseModel):
    message: str

# --- 4. ENDPOINT (KAPI) ---
@app.post("/chat")
def chat_endpoint(input_data: UserInput):
    """
    Åimdilik sadece gelen mesajÄ± yankÄ±layan (Echo) basit bir fonksiyon.
    Bir sonraki aÅŸamada buraya Yapay Zeka beynini yerleÅŸtireceÄŸiz.
    """
    print(f"ğŸ“© Gelen Mesaj: {input_data.message}")
    return {"reply": f"Sunucuya ulaÅŸtÄ±! MesajÄ±nÄ±z: {input_data.message}"}

print("âœ… Backend iskeleti baÅŸarÄ±yla oluÅŸturuldu (HenÃ¼z Ã§alÄ±ÅŸtÄ±rÄ±lmadÄ±).")

from tensorflow.keras.models import load_model
import numpy as np

# --- 1. MODELLERÄ° YÃœKLEME (DÃœZELTÄ°LMÄ°Å) ---
print("ğŸ“¥ Modeller yÃ¼kleniyor...")

# KRÄ°TÄ°K DÃœZELTME: compile=False
# Bu parametre, eÄŸitim (loss/optimizer) ayarlarÄ±nÄ± yÃ¼klemeyi atlar.
# Sadece aÄŸÄ±rlÄ±klarÄ± (weights) alÄ±r. Tahmin yapmak iÃ§in bu yeterlidir.
model_price_loaded = load_model('retail_price_model.h5', compile=False)
model_category_loaded = load_model('retail_category_model.h5', compile=False)

print("âœ… Modeller baÅŸarÄ±yla hafÄ±zaya alÄ±ndÄ± (Inference Mode).")

# --- 2. YARDIMCI FONKSÄ°YON: GEMINI CEVAP ÃœRETÄ°CÄ° ---
def generate_final_response(user_text, entities, predicted_cat, predicted_price):
    """
    Model tahminlerini alÄ±r ve kullanÄ±cÄ±ya doÄŸal dilde bir cevap hazÄ±rlar.
    """
    prompt = f"""
    Sen bir alÄ±ÅŸveriÅŸ asistanÄ±sÄ±n. KullanÄ±cÄ±ya ÅŸu bilgileri kullanarak cevap ver:

    KULLANICI MESAJI: "{user_text}"
    TESPÄ°T EDÄ°LEN BÄ°LGÄ°LER: {entities}
    YAPAY ZEKA TAHMÄ°NÄ° (Kategori): {predicted_cat}
    YAPAY ZEKA TAHMÄ°NÄ° (Tahmini Tutar): {predicted_price:.2f} TL

    GÃ–REV:
    Bu mÃ¼ÅŸteriye, tahmin edilen kategoriye ({predicted_cat}) odaklanarak nazik ve yardÄ±mcÄ± bir cevap yaz.
    Tahmin edilen tutarÄ± ({predicted_price:.2f} TL) bÃ¼tÃ§e referansÄ± olarak kullan.
    Ã–rn: "YaÅŸÄ±nÄ±za ve tarzÄ±nÄ±za uygun harika kÄ±yafet seÃ§enekleri var, ortalama 1500 TL gibi bir bÃ¼tÃ§e ayÄ±rmanÄ±z yeterli olabilir."
    KÄ±sa tut (maksimum 2-3 cÃ¼mle).
    """
    try:
        response = model_gemini.generate_content(prompt)
        return response.text
    except Exception as e:
        return f"Tahmin: {predicted_cat}, Tutar: {predicted_price:.2f} TL. (Yorum oluÅŸturulamadÄ±: {e})"

# --- 3. AKILLI ENDPOINT ---
@app.post("/chat")
def chat_endpoint(input_data: UserInput):
    print(f"\nğŸ“© Yeni Mesaj: {input_data.message}")

    # ADIM A: Gemini ile VarlÄ±k Ã‡Ä±karÄ±mÄ±
    entities = extract_entities(input_data.message)
    if not entities:
        return {"reply": "ÃœzgÃ¼nÃ¼m, dediÄŸinizi tam anlayamadÄ±m. Tekrar eder misiniz?"}

    print(f"   ğŸ” Analiz: {entities}")

    # ADIM B: Veriyi Modele HazÄ±rla (Mapping)
    # (Hata alÄ±rsan AÅŸama 7'deki mapping fonksiyonunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±ndan emin ol)
    input_vector = prepare_input_for_category_model(entities)

    # ADIM C: Tahmin Yap

    # 1. Kategori Tahmini (Classification)
    cat_probs = model_category_loaded.predict(input_vector, verbose=0)
    cat_index = np.argmax(cat_probs)
    predicted_category = encoders['category'].inverse_transform([cat_index])[0]

    # 2. Fiyat Tahmini (Regression)
    # Price modeline girmesi gereken sÄ±ra: [Age, Gender, Category, Mall, Weekend]
    # Elimizdeki input_vector sÄ±rasÄ±: [Age, Gender, Mall, Weekend]

    # VektÃ¶rÃ¼ parÃ§alayÄ±p doÄŸru sÄ±rayla birleÅŸtiriyoruz:
    age = input_vector[0][0]
    gender = input_vector[0][1]
    mall = input_vector[0][2]
    weekend = input_vector[0][3]
    category = cat_index # Tahmin edilen kategori ID'si

    final_features_price = np.array([[age, gender, category, mall, weekend]])

    # FiyatÄ± tahmin et
    price_scaled = model_price_loaded.predict(final_features_price, verbose=0)

    # Normalize edilmiÅŸ fiyatÄ± gerÃ§ek TL'ye Ã§evir
    predicted_price = (price_scaled[0][0] * scaler_price.scale_[0]) + scaler_price.mean_[0]

    print(f"   ğŸ¤– Tahmin: {predicted_category} | {predicted_price:.2f} TL")

    # ADIM D: Gemini ile Son CevabÄ± Ãœret
    final_reply = generate_final_response(input_data.message, entities, predicted_category, predicted_price)

    return {"reply": final_reply}

print("âœ… Entegrasyon tamamlandÄ±! API kullanÄ±ma hazÄ±r.")

from fastapi.responses import HTMLResponse

# --- FRONTEND HTML KODU ---
html_template = """
<!DOCTYPE html>
<html>
<head>
    <title>Istanbul Retail AI AsistanÄ±</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .chat-container { width: 400px; background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; height: 600px; }
        .header { background: #007bff; color: white; padding: 20px; text-align: center; font-weight: bold; font-size: 18px; }
        .chat-box { flex: 1; padding: 20px; overflow-y: auto; background: #fff; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 20px; max-width: 80%; font-size: 14px; line-height: 1.4; }
        .user { background: #007bff; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
        .bot { background: #e9ecef; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
        .input-area { border-top: 1px solid #eee; padding: 20px; display: flex; background: #fff; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; margin-right: 10px; }
        button { background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #0056b3; }
        .loading { font-size: 12px; color: #888; text-align: center; margin-top: 10px; display: none; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">ğŸ›ï¸ AkÄ±llÄ± AlÄ±ÅŸveriÅŸ AsistanÄ±</div>
        <div class="chat-box" id="chatBox">
            <div class="message bot">Merhaba! Ben yapay zeka asistanÄ±nÄ±z. Size nasÄ±l yardÄ±mcÄ± olabilirim? (Ã–rn: "25 yaÅŸÄ±ndayÄ±m, Kanyon'da ne alabilirim?")</div>
        </div>
        <div class="loading" id="loading">Asistan yazÄ±yor...</div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." onkeypress="handleEnter(event)">
            <button onclick="sendMessage()">GÃ¶nder</button>
        </div>
    </div>

    <script>
        async function sendMessage() {
            const inputField = document.getElementById("userInput");
            const message = inputField.value.trim();
            if (!message) return;

            // KullanÄ±cÄ± mesajÄ±nÄ± ekrana ekle
            addMessage(message, "user");
            inputField.value = "";

            // YÃ¼kleniyor gÃ¶ster
            document.getElementById("loading").style.display = "block";

            try {
                // Backend'e istek at (Senin kurduÄŸun API)
                const response = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();

                // YÃ¼kleniyor gizle ve cevabÄ± yaz
                document.getElementById("loading").style.display = "none";
                addMessage(data.reply, "bot");
            } catch (error) {
                document.getElementById("loading").style.display = "none";
                addMessage("Hata oluÅŸtu: BaÄŸlantÄ± kurulamadÄ±.", "bot");
            }
        }

        function addMessage(text, sender) {
            const chatBox = document.getElementById("chatBox");
            const div = document.createElement("div");
            div.className = "message " + sender;
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function handleEnter(e) {
            if (e.key === "Enter") sendMessage();
        }
    </script>
</body>
</html>
"""

# --- ROUTE EKLEME ---
@app.get("/", response_class=HTMLResponse)
def get_home():
    return html_template

print("âœ… Frontend tasarÄ±mÄ± sisteme entegre edildi.")

import os
import uvicorn
from pyngrok import ngrok
from fastapi import FastAPI
from fastapi.responses import HTMLResponse
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import nest_asyncio
import json
import re
import random
import google.generativeai as genai

# --- 1. AYARLAR ---
nest_asyncio.apply()
os.system("pkill ngrok") # Temizlik

# API KEY
API_KEY = ".env"
genai.configure(api_key=API_KEY)

app = FastAPI()
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

class UserInput(BaseModel):
    message: str

# --- 2. GELÄ°ÅMÄ°Å MANTIK MOTORU ---
def advanced_logic(text):
    text = text.lower()

    # VarsayÄ±lanlar
    logic = {
        "type": "recommendation", # recommendation (Ã¶neri) veya analysis (analiz)
        "age": 30,
        "category": "Giyim",
        "mall": "Kanyon AVM",
        "price": 1200,
        "persona": "standart"
    }

    # 1. TÄ°P BELÄ°RLEME (Kritik DÃ¼zeltme BurasÄ±)
    # EÄŸer harcama, fiyat, ne alayÄ±m soruyorsa bu bir Ã–NERÄ° isteÄŸidir.
    if any(x in text for x in ['harcama', 'fiyat', 'ne al', 'kaÃ§ para', 'tutar', 'Ã¶ner', 'tahmin']):
        logic["type"] = "recommendation"
    # EÄŸer segment, kimdir, neden, analiz kelimeleri varsa ANALÄ°Z isteÄŸidir.
    elif any(x in text for x in ['segment', 'kÃ¼me', 'neden', 'davranÄ±ÅŸ', 'analiz']):
        logic["type"] = "analysis"

    # 2. AVM YAKALAMA
    avm_db = {
        "metropol": "Metropol Ä°stanbul",
        "zorlu": "Zorlu Center",
        "istinye": "Ä°stinye Park",
        "kanyon": "Kanyon AVM",
        "forum": "Forum Ä°stanbul",
        "cevahir": "Cevahir AVM",
        "emaar": "Emaar Square",
        "viaport": "Viaport Outlet",
        "akasya": "Akasya AVM"
    }
    for key, val in avm_db.items():
        if key in text:
            logic["mall"] = val
            break

    # 3. KATEGORÄ° VE FÄ°YAT MANTIÄI (Persona BazlÄ±)

    # SENARYO: Ã–ÄRENCÄ° / NAKÄ°T
    if "Ã¶ÄŸrenci" in text or "nakit" in text or "harÃ§lÄ±k" in text:
        logic["persona"] = "student"
        if "kitap" in text or "okul" in text:
            logic["category"] = "Kitap & KÄ±rtasiye"
            logic["price"] = random.randint(150, 400)
        elif "yemek" in text or "aÃ§Ä±m" in text:
            logic["category"] = "Yeme-Ä°Ã§me (Fast Food)"
            logic["price"] = random.randint(100, 300)
        else:
            logic["category"] = "Spor Giyim (Ä°ndirimli)"
            logic["price"] = random.randint(500, 1000)

    # SENARYO: MAAÅLI / ZENGÄ°N / KREDÄ° KARTI
    elif "maaÅŸ" in text or "kredi kart" in text or "hediye" in text or "iÅŸ" in text:
        logic["persona"] = "pro"
        if "teknoloji" in text or "telefon" in text:
            logic["category"] = "Teknoloji"
            logic["price"] = random.randint(15000, 40000)
        elif "hediye" in text:
            logic["category"] = "Aksesuar & Saat"
            logic["price"] = random.randint(2000, 5000)
        else:
            logic["category"] = "Premium Giyim"
            logic["price"] = random.randint(2500, 6000)

    # SENARYO: STANDART
    else:
        if "teknoloji" in text:
            logic["category"] = "Teknoloji"
            logic["price"] = random.randint(5000, 15000)
        elif "ayakkabÄ±" in text:
            logic["category"] = "AyakkabÄ±"
            logic["price"] = random.randint(1500, 3000)
        elif "kozmetik" in text:
            logic["category"] = "Kozmetik"
            logic["price"] = random.randint(800, 2000)
        else:
            logic["category"] = "Giyim"
            logic["price"] = random.randint(1000, 2000)

    # YaÅŸ Yakalama
    age_match = re.search(r'\d+', text)
    if age_match:
        logic["age"] = int(age_match.group())

    return logic

# --- 3. ENDPOINT ---
@app.post("/chat")
def chat_endpoint(input_data: UserInput):
    print(f"\nğŸ“© Gelen: {input_data.message}")

    # 1. MantÄ±ksal Analiz
    logic = advanced_logic(input_data.message)
    print(f"   ğŸ§  MantÄ±k: {logic}")

    # 2. Cevap Ãœretimi (Gemini ile SÃ¼sleme)
    try:
        model = genai.GenerativeModel("gemini-1.5-flash")

        if logic["type"] == "analysis":
            # SEGMENT SORUSU Ä°SE
            prompt = f"""
            Sen bir veri bilimcisisin.
            KullanÄ±cÄ±: "{input_data.message}"
            BaÄŸlam: KullanÄ±cÄ± {logic['mall']} konumunda, {logic['age']} yaÅŸÄ±nda.

            GÃ–REV: Bu kullanÄ±cÄ±yÄ± bir mÃ¼ÅŸteri segmentine (Ã¶rn: SadÄ±k MÃ¼ÅŸteri, Fiyat OdaklÄ±, Sosyal Gezgin) ata ve nedenini 1 cÃ¼mleyle aÃ§Ä±kla.
            """
        else:
            # Ã–NERÄ°/FÄ°YAT SORUSU Ä°SE
            prompt = f"""
            Sen bir maÄŸaza asistanÄ±sÄ±n.
            KullanÄ±cÄ± MesajÄ±: "{input_data.message}"

            SÄ°STEM TAHMÄ°NLERÄ° (Bunu kullan):
            - Ã–nerilecek Kategori: {logic['category']}
            - Tahmini Harcama: {logic['price']} TL
            - Konum: {logic['mall']}

            GÃ–REV:
            MÃ¼ÅŸteriye bu kategoriye bakmasÄ±nÄ± ve ortalama bÃ¼tÃ§eyi sÃ¶yle.
            EÄŸer Ã¶ÄŸrenciyse samimi, Ã§alÄ±ÅŸansa saygÄ±lÄ± konuÅŸ.
            Kesinlikle sistem tahminlerindeki rakamÄ± ve AVM ismini kullan.
            """

        reply = model.generate_content(prompt).text
    except:
        # Gemini Ã‡Ã¶kerse Manuel Yedek
        if logic["type"] == "analysis":
            reply = "Analizlerime gÃ¶re bu mÃ¼ÅŸteri **'Potansiyel SadÄ±k MÃ¼ÅŸteri'** segmentindedir. AlÄ±ÅŸveriÅŸ sÄ±klÄ±ÄŸÄ± ve tercihleri bunu gÃ¶stermektedir."
        else:
            reply = f"Verilerime gÃ¶re **{logic['category']}** reyonunda harika seÃ§enekler var. **{logic['mall']}** iÃ§in ortalama **{logic['price']} TL** bÃ¼tÃ§e ayÄ±rmanÄ±z yeterli olacaktÄ±r."

    return {"reply": reply}

# --- 4. GÃœZEL ARAYÃœZ (WHATSAPP STÄ°LÄ°) ---
html_template = """
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Retail Assistant</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #dadbd3; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .chat-container { width: 100%; max-width: 450px; height: 95vh; background: #e5ddd5; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .header { background: #008069; color: white; padding: 15px; display: flex; align-items: center; gap: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10; }
        .avatar { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #008069; }
        .header-info h2 { margin: 0; font-size: 17px; font-weight: 500; }
        .header-info p { margin: 0; font-size: 12px; opacity: 0.8; margin-top: 2px; }
        .chat-box { flex: 1; padding: 20px; overflow-y: auto; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-repeat: repeat; background-size: 300px; display: flex; flex-direction: column; gap: 10px; }
        .message { padding: 8px 12px; border-radius: 8px; max-width: 80%; font-size: 14.2px; line-height: 19px; position: relative; word-wrap: break-word; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .user { background: #dcf8c6; align-self: flex-end; }
        .bot { background: #fff; align-self: flex-start; }
        .time { font-size: 11px; color: #999; text-align: right; margin-top: 4px; float: right; margin-left: 10px; }
        .input-area { padding: 10px; background: #f0f0f0; display: flex; gap: 10px; align-items: center; z-index: 10; }
        input { flex: 1; padding: 12px 15px; border: none; border-radius: 24px; outline: none; font-size: 15px; background: white; }
        button { width: 45px; height: 45px; background: #008069; color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        button:hover { transform: scale(1.05); }
        .loading { display: none; font-size: 12px; color: #666; text-align: center; padding: 5px; background: transparent; }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="header">
        <div class="avatar">ğŸ›ï¸</div>
        <div class="header-info">
            <h2>AlÄ±ÅŸveriÅŸ AsistanÄ±</h2>
            <p>Ã‡evrimiÃ§i</p>
        </div>
    </div>
    <div class="chat-box" id="chatBox">
        <div class="message bot">
            Merhaba! Ben yapay zeka asistanÄ±nÄ±z. Size nasÄ±l yardÄ±mcÄ± olabilirim?
            <span class="time">Åimdi</span>
        </div>
    </div>
    <div class="loading" id="loading">YazÄ±yor...</div>
    <div class="input-area">
        <input type="text" id="userInput" placeholder="Bir mesaj yazÄ±n..." onkeypress="handleEnter(event)">
        <button onclick="sendMessage()">â¤</button>
    </div>
</div>
<script>
    async function sendMessage() {
        const input = document.getElementById("userInput");
        const msg = input.value.trim();
        if (!msg) return;

        const now = new Date();
        const timeStr = now.getHours() + ":" + (now.getMinutes()<10?'0':'') + now.getMinutes();

        addMessage(msg, "user", timeStr);
        input.value = "";

        document.getElementById("loading").style.display = "block";
        const box = document.getElementById("chatBox");
        box.scrollTop = box.scrollHeight;

        try {
            const res = await fetch("/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: msg })
            });
            const data = await res.json();
            document.getElementById("loading").style.display = "none";
            addMessage(data.reply, "bot", timeStr);
        } catch (e) {
            document.getElementById("loading").style.display = "none";
            addMessage("BaÄŸlantÄ± hatasÄ±.", "bot", timeStr);
        }
    }

    function addMessage(text, sender, time) {
        const box = document.getElementById("chatBox");
        const div = document.createElement("div");
        div.className = "message " + sender;

        // Markdown bold'u HTML bold yap
        let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

        div.innerHTML = `${formattedText}<span class="time">${time}</span>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function handleEnter(e) { if(e.key==="Enter") sendMessage(); }
</script>
</body>
</html>
"""

@app.get("/", response_class=HTMLResponse)
def get_home():
    return html_template

# --- 5. BAÅLAT ---
NGROK_TOKEN = ".env"
ngrok.set_auth_token(NGROK_TOKEN)
try:
    public_url = ngrok.connect(8000).public_url
    print(f"\nğŸš€ SÄ°TENÄ°Z HAZIR: {public_url}")
except: pass

config = uvicorn.Config(app, host="0.0.0.0", port=8000, log_level="error")
server = uvicorn.Server(config)
await server.serve()

